<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Статус узлов</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
</head>
<body class="bg-gray-100 font-sans">
    <nav class="bg-blue-600 text-white p-4">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex space-x-4">
                <a href="/" class="hover:underline">Главная</a>
                <a href="/blockchain" class="hover:underline">Блокчейн</a>
                <a href="/nodes_status" class="hover:underline">Статус узлов</a>
                <a href="/admin" class="hover:underline">Администрирование</a>
                <a href="/test_transaction" class="hover:underline">Тест транзакции</a>
            </div>
            <div>
                {% if current_user.is_authenticated %}
                    <span class="mr-4">{{ current_user.username }}</span>
                    <a href="/logout" class="hover:underline">Выйти</a>
                {% else %}
                    <a href="/login" class="hover:underline mr-4">Войти</a>
                    <a href="/register" class="hover:underline">Регистрация</a>
                {% endif %}
            </div>
        </div>
    </nav>

    <div class="container mx-auto mt-8">
        <h1 class="text-2xl font-bold mb-4">Статус узлов сети</h1>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            {% for node in nodes %}
                <div class="bg-white p-4 rounded shadow">
                    <h2 class="text-lg font-semibold">
                        Узел #{{ node.node_id }}<br>
                        {{ node.host }}:{{ node.port }}
                    </h2>
                    <div class="mt-2">
                        <p><strong>{{ node.block_count }}</strong> Блоков</p>
                        <p>
                            <strong>Статус:</strong>
                            {% if node.is_online %}
                                <span class="text-green-600">Online</span>
                            {% else %}
                                <span class="text-red-600">Offline</span>
                            {% endif %}
                        </p>
                        <p>
                            <strong>Роль:</strong>
                            {% if node.is_leader %}
                                Лидер
                            {% elif node.node_id == 1 %}
                                Север
                            {% elif node.node_id == 2 %}
                                Юг
                            {% elif node.node_id == 3 %}
                                Запад
                            {% else %}
                                Участник
                            {% endif %}
                        </p>
                    </div>
                </div>
            {% endfor %}
        </div>

        <div class="mt-8">
            <h2 class="text-xl font-bold mb-4">Статистика сети</h2>
            <div class="bg-white p-4 rounded shadow">
                <p><strong>Среднее время консенсуса:</strong> {{ network_stats.avg_consensus_time }} сек</p>
                <p><strong>Транзакций в секунду (TPS):</strong> {{ network_stats.tps }}</p>
                <p><strong>Успешность смены вида:</strong> {{ network_stats.view_change_success_rate }}%</p>
            </div>

            <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-white p-4 rounded shadow">
                    <h3 class="text-lg font-semibold mb-2">Время консенсуса</h3>
                    <canvas id="consensusTimeChart"></canvas>
                </div>
                <div class="bg-white p-4 rounded shadow">
                    <h3 class="text-lg font-semibold mb-2">Успешность смены вида</h3>
                    <canvas id="viewChangeSuccessChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // График времени консенсуса
        const consensusTimeData = {{ network_stats.consensus_times|tojson }} || [];
        const consensusTimeCtx = document.getElementById('consensusTimeChart').getContext('2d');
        new Chart(consensusTimeCtx, {
            type: 'line',
            data: {
                labels: consensusTimeData.length ? Array.from({length: consensusTimeData.length}, (_, i) => i + 1) : ['Нет данных'],
                datasets: [{
                    label: 'Время консенсуса (сек)',
                    data: consensusTimeData.length ? consensusTimeData : [0],
                    borderColor: 'rgba(75, 192, 192, 1)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Секунды' },
                        grid: { color: '#e5e7eb' }
                    },
                    x: {
                        title: { display: true, text: 'Последние блоки' },
                        grid: { display: false }
                    }
                },
                plugins: {
                    legend: { labels: { color: '#1f2937' } },
                    tooltip: { enabled: true }
                }
            }
        });

        // График успешности смены вида
        const viewChangeSuccessData = {{ network_stats.view_change_success|tojson }} || [];
        const viewChangeSuccessCtx = document.getElementById('viewChangeSuccessChart').getContext('2d');
        new Chart(viewChangeSuccessCtx, {
            type: 'bar',
            data: {
                labels: viewChangeSuccessData.length ? Array.from({length: viewChangeSuccessData.length}, (_, i) => i + 1) : ['Нет данных'],
                datasets: [{
                    label: 'Успешность смены вида',
                    data: viewChangeSuccessData.length ? viewChangeSuccessData.map(x => x ? 1 : 0) : [0],
                    backgroundColor: viewChangeSuccessData.length ? viewChangeSuccessData.map(x => x ? 'rgba(75, 192, 192, 0.6)' : 'rgba(255, 99, 132, 0.6)') : 'rgba(200, 200, 200, 0.6)',
                    borderColor: viewChangeSuccessData.length ? viewChangeSuccessData.map(x => x ? 'rgba(75, 192, 192, 1)' : 'rgba(255, 99, 132, 1)') : 'rgba(200, 200, 200, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 1,
                        title: { display: true, text: 'Успех (1=Да, 0=Нет)' },
                        grid: { color: '#e5e7eb' }
                    },
                    x: {
                        title: { display: true, text: 'Последние попытки' },
                        grid: { display: false }
                    }
                },
                plugins: {
                    legend: { labels: { color: '#1f2937' } },
                    tooltip: { enabled: true }
                }
            }
        });
    </script>
</body>
</html>
